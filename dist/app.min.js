var ContactCenter=angular.module("ContactCenter",["ngRoute","angularMoment","lodash","angularUtils.directives.dirPagination"]);angular.module("ContactCenter").config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"app/views/calls-list.html",controller:"CallsListCtrl"}).when("/call/:callId",{templateUrl:"app/views/calls-item.html",controller:"CallsItemCtrl"}).when("/about",{templateUrl:"app/views/about.html",controller:"AboutCtrl"}).when("/info",{templateUrl:"app/views/info.html",controller:"InfoCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("ContactCenter").config(function(paginationTemplateProvider){paginationTemplateProvider.setPath("bower_components/angular-utils-pagination/dirPagination.tpl.html")}),angular.module("ContactCenter").controller("AboutCtrl",["$scope",function($scope){}]),angular.module("ContactCenter").controller("CallsItemCtrl",["$scope","$routeParams","dataManager","$window","$timeout",function($scope,$routeParams,dataManager,$window,$timeout){var id=$routeParams.callId;$scope.call={},dataManager.findById(id).then(function(call){console.log(call),$scope.call=call}),$scope.updateItem=function(){$scope.call.evaluation.totalScore=(parseInt($scope.call.evaluation.managerScore)+parseInt($scope.call.evaluation.customerScore))/2,dataManager.put($scope.call).then(function(){alert("Saved"),$window.history.back()},function(){alert("some error happened")})}}]),angular.module("ContactCenter").controller("CallsListCtrl",["$scope","dataManager","$timeout",function($scope,dataManager,$timeout){$scope.calls=[],$scope.search={agentID:"",score:0,duration:0,callAgo:0},$scope.searchText="",$scope.loading="loading",$scope.playerSettings={callMp3:"item_3.mp3",playerID:"none"},$scope.setPlay=function(item,id){$scope.playerSettings.callMp3=item,$scope.playerSettings.playerID=id},$scope.getData=function(reset){var dataDeferred;reset||(reset=!1),$scope.loading="loading",dataManager.inLocalStorage("filters")?($scope.search=dataManager._getFromLocalStorage("filters"),dataDeferred=dataManager.filterData($scope.search,reset)):dataDeferred=dataManager.fetchData(),dataDeferred.then(function(data){$timeout(function(){$scope.loading="",$scope.calls=data},1e3)})},$scope.searchAction=function(data){dataManager._saveToLocalStorage("filters",data),$scope.getData(!0)},$scope.resetFilter=function(){$scope.search={agentID:"",score:0,duration:0,callAgo:0},dataManager._saveToLocalStorage("filters",null),$scope.getData(!0)},$scope.getData()}]),angular.module("ContactCenter").controller("InfoCtrl",["$scope",function($scope){}]),angular.module("ContactCenter").controller("HeaderCtrl",["$scope","$location",function($scope,$location){$scope.isActive=function(path){var active=path===$location.path();return active}}]),angular.module("ContactCenter").directive("back",["$window",function($window){return{restrict:"A",link:function(scope,elem,attrs){elem.bind("click",function(){var c=confirm("are you sure? All changes will be lost!!!");c&&$window.history.back()})}}}]),angular.module("ContactCenter").directive("play",function(){"use strict";return{restrict:"A",link:function(scope,elem,attrs){elem.bind("click",function(event){var holder=elem.parents("#main"),player=holder.find("audio");player.css("display","block");var currentPlayingID=player.attr("data-player");elem.toggleClass("play"),currentPlayingID==attrs.callId?player[0].duration>0&&!player[0].paused?player[0].pause():player[0].play():(player[0].duration>0&&!player[0].paused&&(player[0].pause(),holder.find("#play_"+currentPlayingID).toggleClass("play")),scope.$apply(attrs.play),player[0].load(),player[0].play())})}}}),angular.module("ContactCenter").directive("playerManager",function(){"use strict";return{restrict:"A",link:function(scope,elem,attrs){var holder=elem.parents("#main");elem.bind("pause",function(event){var currentPlayingID=attrs.player,element=holder.find("#play_"+currentPlayingID);element.hasClass("play")&&holder.find("#play_"+currentPlayingID).toggleClass("play")}).bind("play",function(event){var currentPlayingID=attrs.player,element=holder.find("#play_"+currentPlayingID);element.hasClass("play")||holder.find("#play_"+currentPlayingID).toggleClass("play")})}}}),angular.module("ContactCenter").filter("capitalize",function(){return function(input,scope){return null!==input&&(input=input.toLowerCase()),input.substring(0,1).toUpperCase()+input.substring(1)}}),angular.module("ContactCenter").filter("embedUrl",function($sce){return function(audioFile){return null!==audioFile?$sce.trustAsResourceUrl("http://www.kosamja.com/mp3s/"+audioFile):null}}),angular.module("ContactCenter").factory("dataManager",["$q","$http","_","moment",function($q,$http,_,moment){"use strict";var STORAGE_ID="c1-c2",store={model_id:"callID",calls:[],filteredCalls:[],_getFromLocalStorage:function(id){return JSON.parse(localStorage.getItem(STORAGE_ID+"-"+id)||"[]")},_saveToLocalStorage:function(id,item){localStorage.setItem(STORAGE_ID+"-"+id,JSON.stringify(item))},inLocalStorage:function(id){return _.isEmpty(this._getFromLocalStorage(id))?!1:!0},clearCalls:function(){store.calls=[]},fetchData:function(){var id="calls";return store.inLocalStorage(id)?store.get():store.getDummyData()},saveCalls:function(data){var id="calls";return store._saveToLocalStorage(id,data),angular.copy(data,store.calls),store.calls},getDummyData:function(){var deferred=$q.defer(),url="dummy-data/data.json?id=2";return $http.get(url).success(function(data){data.success?(_.forEach(data,function(n,key){var timeA=moment(n.callStart),timeB=moment(n.callEnd);n.timeDifference=timeB.diff(timeA,"minutes")}),deferred.resolve(store.saveCalls(data))):deferred.reject(data)}).error(function(data,status){deferred.reject(data)}),deferred.promise},findById:function(id){var deferred=$q.defer(),calls=store.fetchData();return calls.then(function(data){var element=_.find(data,function(item){return item[store.model_id]==id});deferred.resolve(element)},function(data){deferred.reject(data)}),deferred.promise},findElementIndexById:function(id){var deferred=$q.defer(),calls=store.fetchData();return calls.then(function(data){var index=_.findIndex(data,function(item){return item[store.model_id]==id});-1!==index?deferred.resolve(index):deferred.reject(index)},function(data){deferred.reject(data)}),deferred.promise},filterData:function(options,reset){var deferred=$q.defer();if(!reset&&store.filteredCalls.length)deferred.resolve(store.filteredCalls);else{var calls=store.fetchData();calls.then(function(data){store.filteredCalls=_.filter(store.calls,function(n){var time=moment(n.callEnd);return!(options.score&&n.evaluation.totalScore!=options.score||""!==options.agentID&&options.agentID&&-1==n.agent.agentID.indexOf(options.agentID)||options.duration&&n.timeDifference!=options.duration||options.callAgo&&moment().diff(time,"days")!=options.callAgo)}),deferred.resolve(store.filteredCalls)})}return deferred.promise},get:function(){var deferred=$q.defer(),id="calls";return angular.copy(store._getFromLocalStorage(id),store.calls),deferred.resolve(store.calls),deferred.promise},put:function(call){var deferred=$q.defer(),callId=call[store.model_id],id="calls";return store.findElementIndexById(callId).then(function(index){store.calls[index]=call,store._saveToLocalStorage(id,store.calls),deferred.resolve(callId)},function(index){deferred.reject(index)}),deferred.promise}};return store}]);var lodash=angular.module("lodash",[]);lodash.factory("_",function(){return window._});